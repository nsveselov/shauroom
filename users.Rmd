```{r library}
library(tm)
library(RColorBrewer)
library(ggplot2)
library(wordcloud)
library(cluster)
library(igraph)
library(fpc)
library(tidyr)
library(dplyr)
library(stringr)
library(vkR)
library(devtools)
library(RCurl)
library(httr)
library(RJSONIO)
library(lubridate)
```


```{r загрузка функций}
#не запускайте полностью чанк, это плохая идея, долго оч
source_url("https://gist.githubusercontent.com/paulokopny/63daf8ca42f9d842b122/raw/bf7c8f9f6944b44e7c791cb66f4919bd762f4dc9/vk.R") 
vk <- get.vk.connector(code = "7f2ba74370408f5ca3", app = "karepin", debug = T)
users.get <- function(vk.get_data, user_ids, fields = "sex,bdate,city,country,home_town,education,universities,schools,counters,occupation,relation,personal") {
  method = "users.get"
  assert_that(!is.null(user_ids))
  assert_that(is.character(user_ids))
  assert_that(length(user_ids) == 1)
  assert_that(length(str_split(user_ids, pattern = ",")[[1]]) <= 15000)
  assert_that(is.character(fields))
  assert_that(length(fields) == 1)
  Sys.sleep(1)
  print("Getting data...")
  return(vk.get_data(method=method, user_ids = user_ids, fields = fields))
} #параметры fields можно менять (https://vk.com/dev/fields), правда список инфы,что там предлагают не особо радует
#переменные
full<-read.csv("~/shaverma_df_light.csv")
# full<-read.csv("~/shaverma/shauroom/shaverma_df_light.csv")       # для Руслана
ids<-as.data.frame(full$reviewer_id)
ids<-as.data.frame(ids[!duplicated(ids),])
names(ids) <- c("id")
ids$id<- removePunctuation(as.character(ids$id))
ids$id<- as.character(ids$id)
```

```{r запрос ВК и оформление датафрейма по возвращенным данным}
user_ids<-"5256,511515"
user_ids<-gsub(" ", "", user_ids, fixed = T)
json<-users.get(vk,user_ids)
#этот запрос позволяет получить инфу до 400 человек, чтобы было больше, надо менять код, но как, я не разобрался (скрипт для большого количества ниже)
profiles = sapply(1:length(json), function(z){as.data.frame(t(unlist(json[[z]])))})
profiles = do.call(plyr::rbind.fill, profiles) 
profiles = as.data.frame(profiles, stringsAsFactors = FALSE) 

```

```{r собственно скрипт }

all<- NULL
for (q in 1:2){ #174 
  user_ids<-'1'
    for (i in 1:350) {
      
    user_ids<- paste(user_ids,',',as.character(ids[((q-1)*350+i),c('id')]))
    }
    user_ids<-gsub(" ", "", user_ids, fixed = T)
    json<-users.get(vk,user_ids)
    profiles = sapply(1:length(json), function(z){as.data.frame(t(unlist(json[[z]])))})
    profiles = do.call(plyr::rbind.fill, profiles) 
    profiles = as.data.frame(profiles, stringsAsFactors = FALSE) 
    new<- profiles
    all<-merge(all,new,all=T)
  all<-unique(all)
  
}

alle<-all
alle<- unique(all)
write.csv(all, "Users.csv")
triz<-all
vos<-all
sto<-all
a<-read.csv("~/sss/users.csv")
class(a$uid)
alle$uid<-as.numeric(alle$uid)
```

```{r попытки инфы по группам}
users.get <- function(vk.get_data, user_ids, fields = "sex,bdate,city,country,home_town,education,universities,schools,counters,occupation,relation,personal") {
  method = "users.get"
  assert_that(!is.null(user_ids))
  assert_that(is.character(user_ids))
  assert_that(length(user_ids) == 1)
  assert_that(length(str_split(user_ids, pattern = ",")[[1]]) <= 15000)
  assert_that(is.character(fields))
  assert_that(length(fields) == 1)
  Sys.sleep(1)
  print("Getting data...")
  return(vk.get_data(method=method, user_ids = user_ids, fields = fields))
} #параметры fields можно менять (https://vk.com/dev/fields), правда список инфы,что там предлагают не особо радует
user_ids<-'59138821,141155' #по такому же примеру нужно составить список id голосовавших

j<-users.get(vk,as.character(user_ids)) 
json<-users.get(vk,user_ids)
profiles = sapply(1:length(json), function(z){as.data.frame(t(unlist(json[[z]])))})
profiles = do.call(plyr::rbind.fill, profiles) 
profiles = as.data.frame(profiles, stringsAsFactors = FALSE) 
```

```{r}

#### как получать токен, его нужно обязательно получить, иначе мой код не будет работать ####
r <- GET("https://oauth.vk.com/access_token?client_id=5931348&client_secret=TNErTj22HPljiUMRoCOK&redirect_uri=https://oauth.vk.com/blank.html&code=d4a0098b279bc47555")
content(r, "text")
my_token = "ff635f4744c387ca2ee9bfe8ed3f79a62b82b828113fc7db1c71f04e7722345007e9a439b5128a99d1409"



####### как быстро нарезать айдишники наших юзеров на блоки текста по 998 элементов ########
offset = 1
delta = 999
while (offset < length(ids$id)){
  print(paste(ids$id[offset:delta], collapse = ","))
  offset = offset + 999
  delta = delta + 999
}



######################### как вытаскивать паблики ###############################

# нужно придумать, как из t делать список и как этот список закидывать в user.csv (туда, где хранятся все данные на юзеров)

# тест ::: 20 первых юзеров
for (i in ids$id[1:20]){
  url <- paste('https://api.vk.com/method/users.getSubscriptions?user_id=', i, "&extended=0&fields=id,name", "&v=5.62", "access_token=", my_token, sep = "")
  t <- GET(url)
  str(content(t, "parsed"))}

# бой ::: все юзеры
for (i in ids$id){
  url <- paste('https://api.vk.com/method/users.getSubscriptions?user_id=', i, "&extended=0&fields=id,name", "&v=5.62", "access_token=", my_token, sep = "")
  t <- GET(url)
  str(content(t, "parsed"))}
```

